# 贪吃蛇AI防掉头机制说明

## 问题描述

在贪吃蛇游戏中，蛇不能直接向相反方向移动（180度掉头），这是游戏的基本规则。如果蛇试图掉头，会立即撞到自己的身体导致死亡。

## 解决方案

我们在代码中添加了三处防掉头检查：

### 1. 主决策路径回溯后的检查 (第715-725行)

```cpp
// === 防止180度掉头检查 ===
// 蛇不能直接向相反方向移动（掉头）
int opposite_dir = (me.dir + 2) % 4; // 计算上回合移动方向的相反方向
if (dir == opposite_dir)
{
    log_ss << "ERROR:REVERSE_DIRECTION_BLOCKED,prev_dir:" << me.dir << ",attempt_dir:" << dir << "|";
    str_info += log_ss.str();
    // 使用应急策略选择其他方向
    int choice = last_choice();
    return {choice};
}
```

### 2. 生存模式安全移动分析中的检查 (第575-580行)

```cpp
// === 防止180度掉头检查 ===
int opposite_dir = (me.dir + 2) % 4; // 计算上回合移动方向的相反方向
if (k == opposite_dir)
{
    log_ss << ":REVERSE_BLOCKED|";
    continue;
}
```

### 3. 绝望移动分析中的检查 (第650-655行)

```cpp
// === 防止180度掉头检查 ===
int opposite_dir = (me.dir + 2) % 4;
if (k == opposite_dir)
{
    log_ss << ":REVERSE_BLOCKED|";
    continue;
}
```

## 方向映射

游戏中的方向映射如下：
- 0: 左 (LEFT)
- 1: 上 (UP) 
- 2: 右 (RIGHT)
- 3: 下 (DOWN)

相反方向的计算公式：`opposite_dir = (current_dir + 2) % 4`

例如：
- 如果上回合向右移动(dir=2)，则不能向左移动(dir=0)
- 如果上回合向上移动(dir=1)，则不能向下移动(dir=3)

## 日志输出

当检测到掉头尝试时，日志会显示：
- `REVERSE_BLOCKED`: 在方向遍历中跳过相反方向
- `ERROR:REVERSE_DIRECTION_BLOCKED,prev_dir:X,attempt_dir:Y`: 在主决策中检测到掉头尝试

## 影响

1. **安全性提升**: 防止因掉头导致的意外死亡
2. **决策优化**: 强制AI考虑其他可行方向
3. **应急处理**: 当最优路径会导致掉头时，自动切换到生存模式

这个机制确保了AI始终遵守贪吃蛇游戏的基本规则，提高了生存能力。
